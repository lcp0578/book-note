## 4 面向服务架构设计
#### SOA概述和发展
- SOA架构是一个面向服务的架构，可将其视为组件模型，其将系统整体拆分为多个独立的功能模块，模块之间通过调用接口进行交互，有效整合了应用系统的各项业务功能，系统各个模块之间是松耦合的。
	- SOA架构以企业服务总线链接各个子系统，是集中式技术架构，应用服务间相互依赖导致部署复杂，应用交互使用远程通信，降低了响应速度。
- 微服务架构是SOA架构的进一步优化，去除了ESB企业服务总线，是一个真正意义上去中心化的分布式架构。
	- 其降低了微服务之间的耦合程度，不同的微服务采用不同的数据库技术，服务独立，数据源唯一，应用极易扩展和维护，同时降低了系统复杂性。

#### SOA主要协议和规范
- UDDI（统一描述、发现和集成协议）计划是一个广泛的、开放的行业计划，它使得商业实体能够彼此发现；定义它们怎样在Internet上互相作用，并在一个全球的注册体系架构中共享信息。
- WSDL（Web服务描述语言），是一个用来描述Web服务和说明如何与Web服务通信的XML语言。
	- 可描述三个基本属性：
		- 服务做些什么
		- 如何访问服务
		- 服务位于何处
- SOAP是在分散或分布式的环境中交换信息的简单的协议，是一个基于XML的协议。
	- 它包括4个部分：
		- SOAP封装，定义了一个描述消息中的内容是什么，是谁发送的，谁应当接受并处理它以及如何处理它们的框架；
		- SOAP编码规则，用于表示应用程序需要使用的数据类型的示例；
		- SOAP RPC表示是远程过程调用和应答的协定；
		- SOAP绑定是使用底层协议交换信息。
- REST（表述性状态转移）的设计不只是要适用于互联网环境，而是一个普遍的设计理念，目的是为了让不同的软件或者应用程序在任何网络环境下都可以进行信息的互相传递。
	- 包括四个要素：
		- **资源**：REST是以资源为中心构建，资源可以是一个订单，也可以是一幅图谱。将互联网中一切暴露给客户端的事物都可以看做是一种资源，对资源相关数据和表述进行组合，借助URI（统一资源标识符）标识Web上的资源。
		- **表述**：用表述描述资源在Web中某一个时间的状态。
		- **状态转移**：分为应用状态（用户请求会话信息快照）和资源状态（时间资源请求表述的快照）。
		- **超链接**：在页面中嵌入链接和其他资源建立联系。

#### SOA设计标准和原则
- SOA设计的标准要求
	- **文档标准化**：XML文档，Web描述语言。
	- **通信协议标准**：用消息进行通信，消息使用XML Schema来定义。
	- **应用程序统一登记与集成**：通过一个扮演目录列表角色的登记处来进行维护，UDDI是标准。
	- **服务质量（QoS）**：每项SOA服务都有一个与之相关的服务质量。QoS的一些关键元素有安全需求（例如认证和授权）、可靠性通信以及谁能调用服务的策略。
		- 其服务和标准包括：
			- 可靠性：“仅且仅仅传送一个”“最多传送一次”“重复消息过滤”和“保证消息传送”等特性消息的发送和确认。
			- 安全性：主要包括认证交换、消息完整性和消息保密。
			- 策略：服务提供者有时候会要求服务消费者与某种策略通信。
			- 控制：在SOA中，进程是使用一组离散的服务创建的。BPEL4WS或者WSBPEL是用来控制这些服务的语言。
			- 管理：让系统管理员管理所有，运行在多种环境下的服务的管理系统。
- SOA的设计原则
	- （1）无状态。以避免服务请求者依赖于服务提供者的状态。
	- （2）单一实例。避免功能冗余。
	- （3）明确定义的接口。使用者依赖服务规约调用服务，所以服务定义必须长时间稳定，一旦公布，不能随意更改；服务的定义应尽可能明确，减少使用者的不适当使用；不要让使用者看到服务内部的私有数据。
	- （4）自包含和模块化。服务封装了那些在业务上稳定、重复出现的活动和组件，实现服务的功能实体是完全独立自主的，独立进行部署、版本控制、自我管理和恢复。
	- （5）粗粒度。服务数量不应该太大，依靠消息交互而不是远程过程调用（RPC），通常消息量比较大，但是服务之间的交互频度较低。
	- （6）服务之间的松耦合性。服务使用者看到的是服务的接口，其位置、实现技术和当前状态等对使用者是不可见的，服务私有数据对服务使用者是不可见的。
	- （7）重用能力。服务应该是可以重用的。
	- （8）互操作性、兼容和策略声明。为了确保服务规约的全面和明确，策略称为一个越来越重要的方面。这可以是技术相关的内容，例如一个服务对安全性方面的要求；也可以是跟业务有关的语义方面的内容，例如需要满足的费用或者服务级别方面的要求，这些策略对于服务在交互时是非常重要的。

#### SOA的设计模式
- **服务注册表模式**，支持如下SOA治理功能：
	- （1）服务注册：应用开发者，也叫服务提供者，向注册表公布他们的功能。他们公布服务合同，包括服务身份、位置、方法、绑定、配置、方案和策略等描述性属性。
	- （2）服务位置：也就是服务应用开发者，帮助他们查询注册服务，寻找符合自身要求的服务。注册表让服务的消费者检索服务合同。对谁可以访问注册表，以及什么服务属性通过注册表暴露的控制。
	- （3）服务绑定：服务的消费者利用检索到的服务合同来开发代码，开发的代码将与注册的服务绑定、调用注册的服务以及它们实现互动。开发者常常利用集成的开发环境自动将新开发的服务与不同的新协议、方案和程序间通信所需的其他接口绑在一起。
- **企业服务中线模式**，由中间件技术实现的支持面向服务架构的基础软件平台，支持以后环境中的服务以基于消息和时间驱动模式的交互，并且具有适当的服务质量和可管理性。
- **微服务模式**，不再强调传统SOA架构里面比较重的ESB企业服务总线，同时SOA的思想进入到单个业务系统内部实现真正的组件化。
	- 微服务模式特点：
		- 复杂应用解耦
		- 独立
		- 技术选型灵活
		- 容错
		- 松耦合易扩展
	- 常见的微服务设计模式：
		- **（1）聚合器微服务**：聚合器调用多个微服务实现系统应用程序所需功能，具体有两种形式，一种是将检索到的数据信息进行处理并直接展示；另一种是对获取到的数据信息增加业务逻辑处理后，再进一步发布成一个新的微服务作为一个更高层次的组合微服务，相当于从服务消费者转换成服务提供者。
		- **（2）链式微服务**：客户端或服务在收到请求后，会返回一个经过合并处理的响应，服务之间形成一条调用链。
		- **（3）数据共享微服务**：当服务之间存在强耦合关系时，可能存在多个微服务共享缓存与数据库存储的现象。
		- **（4）异步消息传递微服务**：消息队列将消息写入一个消息队列中，实现业务逻辑以异步方式运行，从而加快系统响应速度。对于一些不必要以同步方式运行的业务逻辑，可以使用消息队列代替REST实现请求、响应，加快服务调用的响应速度。
	- 微服务架构的问题与挑战：
		- 微服务架构分布式特点带来的复杂性；
		- 微服务架构的分区数据库体系，不同服务拥有不同数据库；
		- 增加了测试的复杂性；
		- 在大规模应用部署中，在监控、管理、分发及扩容等方面，微服务也存在着巨大挑战。
